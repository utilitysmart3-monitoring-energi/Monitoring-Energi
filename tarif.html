<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Tarif</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
        }
        
        .custom-input {
            border: 2px solid #6B8E9E;
            color: #2C5F78;
            font-weight: 600;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            text-align: center;
            outline: none;
            transition: all 0.2s;
            cursor: pointer;
            width: 100%;
            max-width: 250px;
        }

        .custom-input:focus {
            border-color: #206A8C;
            box-shadow: 0 0 0 2px rgba(32, 106, 140, 0.2);
        }

        .title-pill {
            border: 2px solid #2C6E91;
            color: #2C6E91;
            border-radius: 9999px;
            padding: 0.5rem 3rem;
            display: inline-block;
            font-weight: 800;
            font-size: 1.25rem;
            text-transform: uppercase;
            margin-bottom: 2rem;
        }

        .table-header {
            background-color: #286583;
            color: white;
            border-radius: 10px;
            /* Shadow effect sesuai gambar */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .table-header th:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .table-header th:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

        .row-text {
            color: #286583;
            font-weight: 700;
        }

        /* Zebra striping halus agar baris 1-18 mudah dilihat */
        tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
    </style>
</head>
<body class="flex flex-col items-center py-10 min-h-screen">

    <!-- 1. JUDUL -->
    <div class="title-pill">
        MONITORING TARIF
    </div>

    <!-- 2. FILTER INPUTS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 w-full max-w-2xl px-4 justify-items-center">
        <div class="relative w-full flex justify-center">
            <input type="date" id="startDate" class="custom-input uppercase text-sm">
        </div>
        <div class="relative w-full flex justify-center">
            <input type="date" id="endDate" class="custom-input uppercase text-sm">
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 w-full max-w-2xl px-4 justify-items-center">
        <div class="relative w-full flex justify-center">
            <input type="time" id="startTime" class="custom-input uppercase text-sm" value="00:00">
        </div>
        <div class="relative w-full flex justify-center">
            <input type="time" id="endTime" class="custom-input uppercase text-sm" value="23:59">
        </div>
    </div>

    <!-- Tombol Hitung -->
    <button onclick="fetchData()" class="mb-8 bg-[#286583] hover:bg-[#1e4d63] text-white font-bold py-2 px-8 rounded-full shadow-md transition transform hover:scale-105">
        Hitung / Refresh Data
    </button>

    <!-- INFO TARIF AKTIF -->
    <div id="tarifInfo" class="mb-4 text-xs font-semibold text-gray-500 bg-gray-100 px-4 py-2 rounded-full hidden">
        Memuat Tarif...
    </div>

    <!-- 3. TABEL DATA -->
    <div class="w-full max-w-6xl px-4 overflow-x-auto mb-10">
        <table class="w-full border-collapse">
            <thead class="table-header text-sm md:text-base">
                <tr>
                    <th class="py-4 px-4 text-left">no</th>
                    <th class="py-4 px-4 text-left">nama mesin</th>
                    <th class="py-4 px-4 text-center">Total Ea Import (Kwh)</th>
                    <th class="py-4 px-4 text-center">T 1 (Kwh)</th>
                    <th class="py-4 px-4 text-center">T 2 (Kwh)</th>
                    <th class="py-4 px-4 text-center leading-tight">Total T1 & T2<br>(Kwh)</th>
                    <th class="py-4 px-4 text-right">Total Tarif (Rp)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="7" class="text-center py-8 text-gray-400">Siap memuat data...</td>
                </tr>
            </tbody>
        </table>
        <div id="lastUpdateInfo" class="text-center text-xs text-gray-400 mt-2"></div>
    </div>

    <script>
        // ==========================================
        // KONFIGURASI SUPABASE
        // ==========================================
        const SUPABASE_URL = 'https://awyohlizbltikpfanugb.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3eW9obGl6Ymx0aWtwZmFudWdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNzE0MjMsImV4cCI6MjA4NTY0NzQyM30.t2WyNo8Th4I-8aMZIRdCT9icVGJrKdT9oCtN04IRTes'; 
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global Tarif (UPDATED SESUAI KOREKSI)
        let TARIF_LWBP = 1035.78; 
        let TARIF_WBP = 1553.67;

        // ==========================================
        // FORMATTER
        // ==========================================
        const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(num);
        const formatCurrency = (num) => new Intl.NumberFormat('id-ID', {
            style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2
        }).format(num);

        // ==========================================
        // 1. AMBIL SETTING TARIF
        // ==========================================
        async function fetchSettings() {
            const infoDiv = document.getElementById('tarifInfo');
            try {
                const { data, error } = await client
                    .from('settings')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (data && data.length > 0) {
                    // Ambil dari DB jika ada
                    TARIF_LWBP = data[0].tarif_lwbp;
                    TARIF_WBP = data[0].tarif_wbp;
                    infoDiv.innerHTML = `Rate (DB): LWBP: Rp ${formatNumber(TARIF_LWBP)} | WBP: Rp ${formatNumber(TARIF_WBP)}`;
                } else {
                    // Jika DB kosong, pakai default yang sudah dikoreksi
                    infoDiv.innerHTML = `Rate (Default): LWBP: Rp ${formatNumber(TARIF_LWBP)} | WBP: Rp ${formatNumber(TARIF_WBP)}`;
                }
                infoDiv.classList.remove('hidden');
            } catch (err) {
                console.error("Gagal ambil tarif, menggunakan default:", err);
                infoDiv.innerHTML = `Rate (Fallback): LWBP: Rp ${formatNumber(TARIF_LWBP)} | WBP: Rp ${formatNumber(TARIF_WBP)}`;
                infoDiv.classList.remove('hidden');
            }
        }

        // ==========================================
        // 2. FUNGSI UTAMA FETCH DATA (FIXED 18 ROWS)
        // ==========================================
        async function fetchData() {
            const tableBody = document.getElementById('tableBody');
            const infoDiv = document.getElementById('lastUpdateInfo');
            
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4">Mengambil data terbaru...</td></tr>`;
            infoDiv.innerText = '';

            await fetchSettings();

            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startTimeStr = document.getElementById('startTime').value;
            const endTimeStr = document.getElementById('endTime').value;

            const startISO = `${startDateStr}T${startTimeStr}:00`;
            const endISO = `${endDateStr}T${endTimeStr}:59`;

            try {
                // 1. Inisialisasi Data Kosong untuk 18 Mesin
                // Kita pakai Object Map agar mudah diakses: machines[1], machines[2], dst.
                let machines = {};
                for (let i = 1; i <= 18; i++) {
                    machines[i] = {
                        sid: i,
                        total_kwh: 0,
                        t1_kwh: 0,
                        t2_kwh: 0,
                        last_update: null
                    };
                }

                // 2. Ambil semua data di rentang waktu
                const { data, error } = await client
                    .from('meter_tariff_snapshot')
                    .select('*')
                    .gte('created_at', startISO) 
                    .lte('created_at', endISO)   
                    .order('created_at', { ascending: false }); // PENTING: Data terbaru diambil duluan

                if (error) throw error;

                // 3. Mapping Data (Ambil yang paling baru per mesin)
                if (data) {
                    data.forEach(row => {
                        const id = row.sid_mesin;
                        // Hanya proses jika ID valid (1-18) DAN belum ada data lebih baru yang masuk
                        // Karena kita sort DESC, data pertama yang ketemu pasti yang paling baru
                        if (id >= 1 && id <= 18 && machines[id].last_update === null) {
                            machines[id].total_kwh = row.total_kwh || 0;
                            machines[id].t1_kwh = row.t1_lwbp_kwh || 0;
                            machines[id].t2_kwh = row.t2_wbp_kwh || 0;
                            machines[id].last_update = row.created_at;
                        }
                    });
                }

                // 4. Render Tabel Statis 1-18
                tableBody.innerHTML = ''; // Bersihkan loading

                // Loop 1 sampai 18 agar urutan rapi
                for (let i = 1; i <= 18; i++) {
                    const m = machines[i];
                    
                    // Hitung Penjumlahan
                    const sumT1T2 = m.t1_kwh + m.t2_kwh;

                    // Hitung Rupiah
                    const biayaT1 = m.t1_kwh * TARIF_LWBP;
                    const biayaT2 = m.t2_kwh * TARIF_WBP;
                    const totalTarif = biayaT1 + biayaT2;

                    // Cek status data (Aktif/Tidak ada data)
                    // Jika last_update masih null, berarti tidak ada data di rentang waktu itu -> Angka 0
                    const hasData = m.last_update !== null;
                    const rowClass = hasData ? "font-bold text-gray-800" : "text-gray-400"; // Abu-abu jika 0

                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-100 hover:bg-blue-50 transition"; // Hover effect
                    
                    tr.innerHTML = `
                        <td class="py-4 px-4 row-text text-left">${i}.</td>
                        <td class="py-4 px-4 row-text text-left">
                            <span class="${rowClass}">Mesin ${i}</span>
                            ${hasData ? `<div class="text-[10px] text-gray-400 font-normal">Updated: ${new Date(m.last_update).toLocaleTimeString('id-ID')}</div>` : ''}
                        </td>
                        <td class="py-4 px-4 text-center ${rowClass}">${formatNumber(m.total_kwh)}</td>
                        <td class="py-4 px-4 text-center ${rowClass}">${formatNumber(m.t1_kwh)}</td>
                        <td class="py-4 px-4 text-center ${rowClass}">${formatNumber(m.t2_kwh)}</td>
                        <td class="py-4 px-4 text-center ${rowClass}">${formatNumber(sumT1T2)}</td>
                        <td class="py-4 px-4 text-right ${rowClass} font-bold">${formatCurrency(totalTarif)}</td>
                    `;
                    tableBody.appendChild(tr);
                }
                
                infoDiv.innerText = `Data ditampilkan berdasarkan snapshot terakhir antara ${startISO.replace('T', ' ')} s/d ${endISO.replace('T', ' ')}`;

            } catch (err) {
                console.error('Error fetching data:', err);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Error: ${err.message}</td></tr>`;
            }
        }

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            fetchData();
        };

    </script>
</body>
</html>
