<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REALTIME MONITORING</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --sidebar-theme: #2b6c8a; /* WARNA TEMA #2b6c8a */
        }

        body {
            background-color: #e9ecef;
            font-family: 'Poppins', sans-serif;
        }
        
        /* --- SIDEBAR STYLE --- */
        .offcanvas {
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            width: 300px !important;
        }
        .offcanvas-header {
            border-bottom: 1px solid #eee;
        }
        .offcanvas-title {
            color: var(--sidebar-theme);
            font-weight: 800;
            letter-spacing: 1px;
        }

        .nav-btn-custom {
            display: flex;
            align-items: center;
            background-color: white;
            color: var(--sidebar-theme);
            border: 2px solid var(--sidebar-theme);
            border-radius: 50px;
            padding: 12px 25px;
            margin-bottom: 20px;
            text-decoration: none;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .nav-btn-custom:hover {
            background-color: var(--sidebar-theme);
            color: white;
            box-shadow: 0 5px 15px rgba(43, 108, 138, 0.3);
        }

        .nav-btn-custom i {
            font-size: 1.8rem;
            width: 40px;
            text-align: center;
            margin-right: 15px;
        }

        /* --- HEADER --- */
        .app-header {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 3px solid var(--sidebar-theme);
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;             
            justify-content: space-between; 
            align-items: center;       
        }
        
        .btn-menu-toggle {
            color: var(--sidebar-theme);
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .app-title {
            color: var(--sidebar-theme);
            font-weight: 800;
            margin: 0;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-size: 1.1rem;
        }
        .mqtt-status {
            text-align: right;
            font-size: 0.8rem;
        }

        /* --- GRID TOMBOL --- */
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }

        .btn-machine {
            border: none;
            border-radius: 12px;
            padding: 15px;
            font-size: 1rem;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            cursor: pointer;
        }
        .btn-machine:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); filter: brightness(1.1); }

        /* --- WARNA STATUS --- */
        .bg-waiting { background: linear-gradient(145deg, #6c757d, #495057); border: 2px solid #adb5bd; }
        .bg-offline { background: linear-gradient(145deg, #dc3545, #b02a37); border: 2px solid #ff6b6b; }
        .bg-standby { background: linear-gradient(145deg, #0d6efd, #0a58ca); border: 2px solid #4dabf7; animation: glow-blue 2s infinite; }
        .bg-running { background: linear-gradient(145deg, #198754, #146c43); border: 2px solid #20c997; animation: glow-green 1.5s infinite; }

        @keyframes glow-blue { 0% { box-shadow: 0 0 5px rgba(13, 110, 253, 0.5); } 50% { box-shadow: 0 0 20px rgba(13, 110, 253, 0.8); border-color: #80c7ff; } 100% { box-shadow: 0 0 5px rgba(13, 110, 253, 0.5); } }
        @keyframes glow-green { 0% { box-shadow: 0 0 5px rgba(25, 135, 84, 0.5); } 50% { box-shadow: 0 0 20px rgba(25, 135, 84, 0.8); border-color: #75b798; } 100% { box-shadow: 0 0 5px rgba(25, 135, 84, 0.5); } }

        .machine-name { font-weight: 800; font-size: 1.1rem; margin-bottom: 0; text-align: center; }
        .machine-id-small { display: none; } 

        /* Modal Styles */
        .modal-content { border-radius: 20px; overflow: hidden; border: none; }
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #eee; }
        .modal-title { color: #333; font-weight: 800; letter-spacing: 1px; }
        
        .info-card { color: white; border-radius: 15px; padding: 20px; margin: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: background-color 0.3s ease; }
        .info-title { text-align: center; font-weight: 800; margin-bottom: 5px; font-size: 1.3rem; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .info-subtitle { text-align: center; font-size: 0.75rem; opacity: 0.8; margin-bottom: 15px; font-family: monospace; letter-spacing: 1px; }
        .status-badge { text-align: center; background: rgba(0,0,0,0.25); padding: 8px 20px; border-radius: 30px; display: inline-block; font-weight: bold; font-size: 1rem; margin-bottom: 15px; width: 100%; border: 1px solid rgba(255,255,255,0.3); }
        
        .param-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; border-bottom: 1px dotted rgba(255,255,255,0.4); padding-bottom: 4px; }
        .param-label { font-weight: 500; }
        .param-value { font-family: 'Consolas', monospace; font-weight: bold; }

        .btn-ai-analyze { width: 100%; background: linear-gradient(135deg, #6610f2 0%, #a4508b 100%); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(102, 16, 242, 0.3); transition: all 0.3s ease; }
        .btn-ai-analyze:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 16, 242, 0.5); color: white; }
        .ai-result-box { background-color: #f8f9fa; border-left: 5px solid #6610f2; border-radius: 8px; padding: 15px; margin-top: 20px; margin-bottom: 20px; color: #333; font-size: 0.9rem; display: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .ai-result-header { color: #6610f2; font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .ai-loading { text-align: center; padding: 10px; display: none; color: #6610f2; font-style: italic; }
        
        @media (min-width: 768px) {
            .machine-grid { grid-template-columns: repeat(3, 1fr); }
            .modal-dialog { max-width: 400px; }
        }
    </style>
</head>
<body>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">MENU</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column justify-content-center p-4">
            
            <a href="index.html" class="nav-btn-custom">
                <i class="fas fa-home"></i>
                <span class="nav-btn-text">HOME</span>
            </a>

            <a href="menu_utama.html" class="nav-btn-custom">
                <i class="fas fa-th-large"></i>
                <span class="nav-btn-text">MENU UTAMA</span>
            </a>

            <a href="download_data.html" class="nav-btn-custom">
                <i class="fas fa-cloud-download-alt"></i>
                <span class="nav-btn-text">UNDUH DATA</span>
            </a>

            <a href="informasi_akun.html" class="nav-btn-custom">
                <i class="fas fa-user"></i>
                <span class="nav-btn-text">AKUN</span>
            </a>

        </div>
    </div>

    <div class="app-header">
        <div class="header-left">
            <button class="btn-menu-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="fas fa-bars"></i>
            </button>
            <h5 class="app-title ms-2">POWER METER MONITORING</h5>
        </div>
        
        <div class="mqtt-status">
            <div>Connection: <span id="mqtt-badge" class="badge bg-secondary">Connecting...</span></div>
            <div class="text-muted mt-1" id="last-update" style="font-size: 0.75rem; font-weight: 500;">Waiting...</div>
        </div>
    </div>

    <div class="container mb-5" style="padding-bottom: 20px;">
        <div class="machine-grid" id="button-container">
            </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title w-100 text-center">Realtime Monitoring</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="info-card" id="modal-card-bg" style="background: linear-gradient(145deg, #6c757d, #495057);">
                        <h6 class="info-title" id="modal-machine-name">MESIN</h6>
                        <div class="info-subtitle" id="modal-machine-id">ID: #</div>
                        
                        <div class="text-center">
                            <span id="modal-status-text" class="status-badge">WAITING DATA...</span>
                        </div>

                        <div id="modal-params"></div>

                        <button class="btn-ai-analyze" onclick="analyzeWithGemini()">
                            <i class="fas fa-magic"></i>Machine AI Analytics
                        </button>
                    </div>

                    <div class="container pb-3">
                         <div id="ai-loading" class="ai-loading">
                            <i class="fas fa-spinner fa-spin"></i> Menganalisa data mesin...
                        </div>
                        <div id="ai-result" class="ai-result-box">
                            <div class="ai-result-header"><i class="fas fa-robot"></i> Laporan AI Technician</div>
                            <div id="ai-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const apiKey = "AIzaSyDPSlhgkwljFpFaejXqQBDyZlMp2PEH2Iw"; // API Key Gemini

    const machineNames = {
        1: "UNKNOW", 2: "UNKNOW", 3: "UNKNOW", 4: "UNKNOW",
        5: "MESIN 41", 6: "MESIN 40", 7: "MESIN 39", 8: "UNKNOW",
        9: "HEATER MC 5", 10: "MESIN 5", 11: "UNKNOW", 12: "MESIN 34",
        13: "MESIN 35", 14: "UNKNOW", 15: "UNKNOW", 16: "MESIN 38",
        17: "MESIN 36", 18: "MESIN 37"
    };

    const totalMesin = 18;
    let selectedMachineId = null;
    let machineData = {}; 
    let detailModal;
    let machineTimers = {};

    // --- 1. GENERATE TOMBOL MESIN ---
    const btnContainer = document.getElementById('button-container');
    
    for (let i = 1; i <= totalMesin; i++) {
        let displayName = machineNames[i]; 
        btnContainer.innerHTML += `
            <button id="btn-machine-${i}" class="btn-machine bg-waiting" onclick="showDetail(${i})">
                <span class="d-block machine-name">${displayName}</span>
            </button>
        `;
    }

    // --- 2. LOGIKA STATUS ---
    function determineStatus(voltage, current) {
        const v = Number(voltage) || 0;
        const c = Number(current) || 0;

        if (v === 0 && c === 0) {
            return { text: 'OFFLINE', colorClass: 'bg-offline', modalColor: 'linear-gradient(145deg, #dc3545, #b02a37)' };
        } else if (v > 0 && c === 0) {
            return { text: 'STANDBY', colorClass: 'bg-standby', modalColor: 'linear-gradient(145deg, #0d6efd, #0a58ca)' };
        } else if (v > 0 && c > 0) {
            return { text: 'RUNNING', colorClass: 'bg-running', modalColor: 'linear-gradient(145deg, #198754, #146c43)' };
        }
        return { text: 'WAITING', colorClass: 'bg-waiting', modalColor: 'linear-gradient(145deg, #6c757d, #495057)' };
    }

    // --- FUNGSI KONVERSI WAKTU OP TIME ---
    function formatOpTime(rawSeconds) {
        if (rawSeconds === undefined || rawSeconds === null) return '-';
        let days = Math.floor(rawSeconds / 86400);
        let hours = Math.floor((rawSeconds % 86400) / 3600);
        return `${days} Hari, ${hours} Jam`;
    }

    // --- 3. MODAL & AI ---
    function showDetail(id) {
        selectedMachineId = id;
        document.getElementById('modal-machine-name').innerText = machineNames[id];
        document.getElementById('modal-machine-id').innerText = `DEVICE ID: ${id}`;
        document.getElementById('ai-result').style.display = 'none';
        document.getElementById('ai-loading').style.display = 'none';
        
        updateModalUI(id); 
        if (!detailModal) detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
        detailModal.show();
    }

    async function analyzeWithGemini() {
        const data = machineData[selectedMachineId];
        if (!data) { alert("Belum ada data untuk dianalisa!"); return; }

        const aiResultBox = document.getElementById('ai-result');
        const aiLoading = document.getElementById('ai-loading');
        const aiContent = document.getElementById('ai-content');

        aiResultBox.style.display = 'none';
        aiLoading.style.display = 'block';

        const machineName = machineNames[selectedMachineId] || "Mesin " + selectedMachineId;
        const promptText = `
            Bertindaklah sebagai ahli Electrical Engineer senior. Analisa data ${machineName}:
            Voltage: ${data.voltage}V, Current: ${data.current_i1}A, PF: ${data.pf}, Active Power: ${data.active_p}W, Freq: ${data.freq}Hz, Total Energy: ${data.total_ea}kWh.
            
            1. Status Kesehatan Mesin (Singkat).
            2. Analisa Efisiensi (PF).
            3. 3 Rekomendasi Maintenance (Bahasa Indonesia).
            Format Markdown rapi.
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            const aiText = result.candidates[0].content.parts[0].text;
            aiContent.innerHTML = marked.parse(aiText);
            aiLoading.style.display = 'none';
            aiResultBox.style.display = 'block';
        } catch (error) {
            console.error("Gemini Error:", error);
            aiLoading.style.display = 'none';
            aiResultBox.style.display = 'block';
            aiContent.innerHTML = "<p class='text-danger'>Gagal menghubungi AI Technician. Coba lagi nanti.</p>";
        }
    }

    function updateModalUI(id) {
        const data = machineData[id] || {};
        const params = document.getElementById('modal-params');
        const cardBg = document.getElementById('modal-card-bg');
        const statusTextDiv = document.getElementById('modal-status-text');

        let status;
        if (data.voltage !== undefined) {
            status = determineStatus(data.voltage, data.current_i1);
        } else {
            status = { text: 'WAITING DATA...', modalColor: 'linear-gradient(145deg, #6c757d, #495057)' };
        }

        cardBg.style.background = status.modalColor;
        statusTextDiv.innerText = status.text;

        const fmt = (val, fixed=2, unit='') => val !== undefined ? `${val.toFixed(fixed)} ${unit}` : '-';

        // --- UPDATE: URUTAN 1-14 SESUAI BLUEPRINT ---
        params.innerHTML = `
            <div class="param-row"><span class="param-label">1. Total Ea</span><span class="param-value">${fmt(data.total_ea, 2, 'kWh')}</span></div>
            <div class="param-row"><span class="param-label">2. Total Er</span><span class="param-value">${fmt(data.total_er, 2, 'kVARh')}</span></div>
            <div class="param-row"><span class="param-label">3. Partial Ea</span><span class="param-value">${fmt(data.partial_ea, 2, 'kWh')}</span></div>
            <div class="param-row"><span class="param-label">4. Partial Er</span><span class="param-value">${fmt(data.partial_er, 2, 'kVARh')}</span></div>
            <div class="param-row"><span class="param-label">5. Voltage (L-L Avg)</span><span class="param-value">${fmt(data.voltage, 1, 'Volt')}</span></div>
            <div class="param-row"><span class="param-label">6. Current (I1, I2, I3)</span><span class="param-value">${fmt(data.current_i1, 1)}A, ${fmt(data.current_i2, 1)}A, ${fmt(data.current_i3, 1)}A</span></div>
            <div class="param-row"><span class="param-label">7. Power (P) Active</span><span class="param-value">${fmt(data.active_p, 0, 'Watt')}</span></div>
            <div class="param-row"><span class="param-label">8. Power (Q) Reactive</span><span class="param-value">${fmt(data.reactive_q, 0, 'VAR')}</span></div>
            <div class="param-row"><span class="param-label">9. Power (S) Apparent</span><span class="param-value">${fmt(data.apparent_s, 2, 'kVA')}</span></div>
            <div class="param-row"><span class="param-label">10. PF (Total)</span><span class="param-value">${fmt(data.pf, 3)}</span></div>
            <div class="param-row"><span class="param-label">11. Freq</span><span class="param-value">${fmt(data.freq, 2, 'Hz')}</span></div>
            <div class="param-row"><span class="param-label">12. Op Time (Load Time)</span><span class="param-value">${formatOpTime(data.op_time)}</span></div>
            <div class="param-row"><span class="param-label">13. Tarif T1</span><span class="param-value">${fmt(data.tarif_t1, 1, 'kWh')}</span></div>
            <div class="param-row" style="border-bottom:none"><span class="param-label">14. Tarif T2</span><span class="param-value">${fmt(data.tarif_t2, 1, 'kWh')}</span></div>
        `;
    }

    // --- MQTT ---
    const mqttBroker = "broker.hivemq.com";
    const mqttPort = 8884; 
    const topicBase = "monitoring/data/powermeter"; 
    const clientID = "WebApp_" + new Date().getTime(); 
    const client = new Paho.MQTT.Client(mqttBroker, mqttPort, clientID);

    function onConnect() {
        console.log("MQTT Connected");
        document.getElementById('mqtt-badge').className = 'badge bg-success';
        document.getElementById('mqtt-badge').innerText = 'Connected';
        client.subscribe(topicBase + "/#");
    }

    function onMessageArrived(message) {
        try {
            const topicParts = message.destinationName.split("/");
            const meterId = parseInt(topicParts[topicParts.length - 1]);
            const data = JSON.parse(message.payloadString);
            machineData[meterId] = data;

            const btn = document.getElementById(`btn-machine-${meterId}`);
            if(btn) {
                const status = determineStatus(data.voltage, data.current_i1);
                btn.classList.remove('bg-waiting', 'bg-offline', 'bg-standby', 'bg-running');
                btn.classList.add(status.colorClass);

                clearTimeout(machineTimers[meterId]);
                machineTimers[meterId] = setTimeout(() => {
                    btn.classList.remove('bg-offline', 'bg-standby', 'bg-running');
                    btn.classList.add('bg-waiting');
                    delete machineData[meterId];
                    if (selectedMachineId === meterId && document.getElementById('detailModal').classList.contains('show')) {
                        updateModalUI(meterId);
                    }
                }, 300000);
            }

            document.getElementById('last-update').innerText = "Last: " + new Date().toLocaleTimeString();

            if (selectedMachineId === meterId && document.getElementById('detailModal').classList.contains('show')) {
                updateModalUI(meterId);
            }
        } catch (e) { console.error("Err:", e); }
    }

    client.onConnectionLost = (r) => { 
        console.log("Lost", r); 
        document.getElementById('mqtt-badge').className = 'badge bg-danger';
        document.getElementById('mqtt-badge').innerText = 'Lost';
        setTimeout(connectMQTT, 5000); 
    };
    client.onMessageArrived = onMessageArrived;
    function connectMQTT() { 
        client.connect({ useSSL: true, onSuccess: onConnect, onFailure: (e)=>{console.log("Fail",e); setTimeout(connectMQTT, 5000);} }); 
    }
    connectMQTT();
</script>

</body>
</html>
